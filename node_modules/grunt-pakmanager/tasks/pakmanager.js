/*
 * grunt-pakmanager
 * https://github.com/coolaj86/grunt-pakmanager
 *
 * Copyright (c) 2013 AJ ONeal
 * Licensed under the Apache2 license.
 */

'use strict';

var Pakmanager = require('pakmanager')
  , path = require('path')
  ;

module.exports = function(grunt) {

  // Please see the Grunt documentation for more information regarding task
  // creation: http://gruntjs.com/creating-tasks

  grunt.registerMultiTask('pakmanager', 'Pacakges CommonJS modules into a single file', function () {
    var me = this
      ;

    // Iterate over all specified file groups.
    this.files.forEach(function(f) {
      var pakmanager = Pakmanager.create()
        , promise = me.async()
        , pathname = f.src
        ;

      if (/\.js$/.test(f.src)) {
        pathname = path.dirname(f.src);
      }

      pakmanager.build(promise, { target: me.target, packageRoot: pathname, outfile: f.dest});
      /*
      // Package CommonJS module as a whole
      grunt.util.spawn({
          "cmd": "pakmanager"
        , args: ["-e", me.target, "build", f.src, f.dest]
      }, me.async()); 
      */
    }, this);
  });

};
